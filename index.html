<script>
/* ================= CONFIG ================= */
const TMDB_KEY = "09ca3ca71692ba80b848d268502d24ed"; 
const BASE_URL = "https://api.themoviedb.org/3";
const IMG_URL  = "https://image.tmdb.org/t/p/w500";

const API_SEARCH = "https://cinegenius-archive.vercel.app/api/smart-search";
const API_INTEL  = "https://cinegenius-archive.vercel.app/api/intel-brief";

/* ================= STATE ================= */
let currentMode  = "filter";
let browseType   = "movie";
let curateType   = "movie";
let currentPage  = 1;
let isFetching   = false;
let curatedTitles = []; // ðŸ”‘ TRACK AI-USED TITLES
let snowInterval;

/* ================= INIT ================= */
window.onload = () => {
    const genres = [
        {id:28,n:"Action"}, {id:878,n:"Sci-Fi"}, {id:27,n:"Horror"},
        {id:35,n:"Comedy"}, {id:18,n:"Drama"}, {id:12,n:"Adventure"}
    ];
    const container = document.getElementById("genre-container");

    genres.forEach(g => {
        const d = document.createElement("div");
        d.className = "genre-pill";
        d.innerText = g.n;
        d.dataset.id = g.id;
        d.onclick = () => d.classList.toggle("selected");
        container.appendChild(d);
    });

    checkSnowDate();
    resetAndRunBrowse();
};

/* ================= THEME ================= */
function toggleTheme() {
    const body = document.body;
    const current = body.getAttribute("data-theme");
    body.setAttribute("data-theme", current === "dark" ? "light" : "dark");
    document.getElementById("theme-icon").innerHTML = current === "dark" ? "â˜¾" : "â˜€";
}

/* ================= SNOW ================= */
function checkSnowDate() {
    const d = new Date();
    if (d.getMonth() === 11 || (d.getMonth() === 0 && d.getDate() <= 2)) {
        document.getElementById("btn-snow").style.display = "flex";
    }
}

function toggleSnow() {
    const btn = document.getElementById("btn-snow");
    if (btn.classList.contains("active")) {
        btn.classList.remove("active");
        clearInterval(snowInterval);
        document.querySelectorAll(".snowflake").forEach(s => s.remove());
    } else {
        btn.classList.add("active");
        snowInterval = setInterval(createSnowflake, 150);
    }
}

function createSnowflake() {
    const s = document.createElement("div");
    s.className = "snowflake";
    s.innerText = "â„";
    s.style.left = Math.random() * 100 + "vw";
    const dur = Math.random() * 3 + 2;
    s.style.animationDuration = dur + "s";
    document.body.appendChild(s);
    setTimeout(() => s.remove(), dur * 1000);
}

/* ================= MODES ================= */
function switchMode(mode) {
    currentMode = mode;

    ["btn-browse","btn-search","btn-know"].forEach(id =>
        document.getElementById(id).classList.remove("active")
    );

    document.getElementById(
        `btn-${mode === "filter" ? "browse" : mode === "search" ? "search" : "know"}`
    ).classList.add("active");

    ["filter","search","dossier"].forEach(m =>
        document.getElementById(`input-${m}`).style.display =
            (mode === (m === "dossier" ? "knowledge" : m)) ? "block" : "none"
    );

    if (mode === "filter") resetAndRunBrowse();
}

/* ================= BROWSE ================= */
function setBrowseType(t) {
    browseType = t;
    ["b-btn-movie","b-btn-tv"].forEach(id =>
        document.getElementById(id).classList.remove("active")
    );
    document.getElementById(t === "movie" ? "b-btn-movie" : "b-btn-tv")
        .classList.add("active");
    resetAndRunBrowse();
}

function resetAndRunBrowse() {
    currentPage = 1;
    document.getElementById("grid-container").innerHTML = "";
    runBrowseSearch();
}

async function runBrowseSearch() {
    if (isFetching) return;
    isFetching = true;

    try {
        const genres = [...document.querySelectorAll(".genre-pill.selected")]
            .map(g => g.dataset.id)
            .join(",");

        const res = await fetch(
            `${BASE_URL}/discover/${browseType}?api_key=${TMDB_KEY}&page=${currentPage}` +
            (genres ? `&with_genres=${genres}` : "")
        );

        const data = await res.json();
        renderGrid(data.results || []);
        document.getElementById("btn-load-more").style.display =
            data.page < data.total_pages ? "block" : "none";
    } finally {
        isFetching = false;
    }
}

/* ================= AI CURATE ================= */
function setCurateType(t) {
    curateType = t;
    ["c-btn-movie","c-btn-tv"].forEach(id =>
        document.getElementById(id).classList.remove("active")
    );
    document.getElementById(t === "movie" ? "c-btn-movie" : "c-btn-tv")
        .classList.add("active");
}

function resetAndRunCurate() {
    runCurateSearch(false);
}

async function runCurateSearch(isLoadMore = false) {
    if (isFetching) return;
    isFetching = true;

    const grid = document.getElementById("grid-container");
    const loadMoreBtn = document.getElementById("btn-load-more");

    if (!isLoadMore) {
        grid.innerHTML = `
            <div style="grid-column:1/-1;text-align:center;padding:50px;
            font-weight:900;color:var(--accent);">
            AI CURATOR IS THINKINGâ€¦
            </div>`;
        curatedTitles = [];
    } else {
        loadMoreBtn.innerHTML = "AI IS FINDING MOREâ€¦";
    }

    try {
        const res = await fetch(API_SEARCH, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                refTitle: document.getElementById("ref-search").value,
                userPrompt: document.getElementById("ai-context").value,
                type: curateType,
                exclude: curatedTitles
            })
        });

        const aiData = await res.json();

        const results = (await Promise.all(
            aiData.map(async item => {
                const s = await fetch(
                    `${BASE_URL}/search/${curateType}?api_key=${TMDB_KEY}&query=${encodeURIComponent(item.title)}`
                );
                const d = await s.json();
                if (d.results?.[0]) {
                    d.results[0].match_score = item.score;
                    curatedTitles.push(item.title);
                    return d.results[0];
                }
            })
        )).filter(Boolean);

        if (!isLoadMore) grid.innerHTML = "";
        renderGrid(results, true);

        loadMoreBtn.style.display = "block";
        loadMoreBtn.innerHTML = "Load More Curated Titles";
    } catch (e) {
        console.error(e);
    } finally {
        isFetching = false;
    }
}

/* ================= LOAD MORE ================= */
function loadMore() {
    if (currentMode === "filter") {
        currentPage++;
        runBrowseSearch();
    } else if (currentMode === "search") {
        runCurateSearch(true);
    }
}

/* ================= GRID ================= */
function renderGrid(list, isAi = false) {
    const grid = document.getElementById("grid-container");

    list.forEach(m => {
        if (!m.poster_path) return;

        const card = document.createElement("div");
        card.className = "exhibit-card";
        card.onclick = () => {
            switchMode("knowledge");
            document.getElementById("know-search").value = m.title || m.name;
            runKnowledgeSearch();
        };

        card.innerHTML = `
            <div class="poster-frame">
                <img src="${IMG_URL + m.poster_path}">
            </div>
            <div style="font-weight:700;font-size:14px;">
                ${m.title || m.name}
            </div>
            ${isAi ? `<div style="color:var(--accent);font-size:10px;font-weight:900;">
                MATCH: ${m.match_score}%
            </div>` : ""}
        `;

        grid.appendChild(card);
    });
}

/* ================= INTEL ================= */
async function runKnowledgeSearch() {
    const grid = document.getElementById("grid-container");
    grid.innerHTML = "Searchingâ€¦";

    try {
        const sRes = await fetch(
            `${BASE_URL}/search/multi?api_key=${TMDB_KEY}&query=${encodeURIComponent(document.getElementById("know-search").value)}`
        );
        const sData = await sRes.json();
        const basic = sData.results[0];

        const aiRes = await fetch(API_INTEL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                title: basic.title || basic.name,
                type: basic.media_type
            })
        });

        const intel = await aiRes.json();

        grid.innerHTML = `
            <div style="grid-column:1/-1;">
                <h2>${basic.title || basic.name}</h2>
                <p>${intel.tagline_ai}</p>
                <p>${intel.cultural_impact}</p>
            </div>`;
    } catch {
        grid.innerHTML = "Error loading intel.";
    }
}
</script>
